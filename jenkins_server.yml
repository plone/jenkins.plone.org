---
# Jenkins server for Plone CI testing

- hosts: jenkins.plone.org
  remote_user: root
  roles:
    - plone.jenkins_server
  vars:
    admin_email: tisto@plone.org
    simple_theme_css_url: https://rawgit.com/plone/jenkins.plone.org/master/jenkins.plone.org.css
    simple_theme_js_url: https://cdnjs.cloudflare.com/ajax/libs/doony/2.1/js/doony.min.js
    jenkins_admins:
      - tisto
      - gforcada
      - svx
      - bloodbare
    github_orgs:
      - plone
      - collective
    node_names:
      - Node1
      - Node2
      - Node3
      - Node4
  vars_files:
    - secrets.yml

  tasks:

    # Set Hostname
    - hostname: name=jenkins.plone.org

    # Install mr.roboto
    - name: Install nginx-extras
      apt: name=nginx-extras state=present
    - name: Install supervisor
      pip: name=supervisor
    - name: Checkout mr.roboto
      git: repo=https://github.com/plone/mr.roboto.git dest=/srv/mr.roboto
    - name: Run mr.roboto bootstrap
      shell: python2.7 bootstrap.py chdir=/srv/mr.roboto/
    - name: Run mr.roboto buildout
      shell: bin/buildout chdir=/srv/mr.roboto/
      notify: Restart mr.roboto

    # Install munin
    - name: Install munin
      apt: name=munin state=present
    - lineinfile: dest=/etc/munin/munin.conf regexp=^#htmldir line=htmldir /var/cache/munin/www
    - lineinfile: dest=/etc/munin/munin.conf regexp=^#tmpldir line=tmpldir /etc/munin/templates
    - lineinfile: dest=/etc/munin/munin.conf regexp=^[localhost.localdomain] line=[jenkins.plone.org]
    # XXX: not sure if we want to protect munin with pw yet.
    #- htpasswd: path=/etc/nginx/passwdfile name=guest password=guest owner=root group=www-data mode=0640

  handlers:

    - name: Start mr.roboto
      supervisorctl: name=all state=started config=/srv/mr.roboto/supervisord.conf
    - name: Restart mr.roboto
      supervisorctl: name=all state=started config=/srv/mr.roboto/supervisord.conf
