# YAML based configuration for jobs on jenkins.plone.org.
#
# Use this configuration with jenkins-job-builder:
# https://github.com/openstack-infra/jenkins-job-builder
#
# See [1] on how to use these jobs defined below.
#
# [1] http://jenkinsploneorg.readthedocs.org

- project:
    name: workflow
    jobs:
        - 'workflow-5.0'

- project:
    name: pull-request
    jobs:
        - 'pull-request'

- project:
    name: Plone 5.0
    jobs:
        - 'plone-5.0-python-2.7'
        - 'plone-5.0-python-2.7-robot'
        - 'plone-5.0-python-2.7-at'


- project:
    name: Plone 4.3
    python-version:
        - '2.7':
            pybinary: '$PYTHON27'
        - '2.6':
            pybinary: '$PYTHON26'
    jobs:
        - 'plone-4.3-python-{python-version}'


- project:
    name: PLIPs
    plip:
        - 10359-language-controlpanel:
            buildout: plips/plip10359-language-controlpanel.cfg
            branch: 5.0
        - 10359-filter-controlpanel:
            buildout: plips/plip10359-filter-controlpanel.cfg
            branch: 5.0
        - 10359-security-controlpanel:
            buildout: plips/plip10359-security-controlpanel.cfg
            branch: 5.0
        - 13091-multilingual:
            buildout: plips/plip13091-multilingual.cfg
            branch: 5.0
        - 13260-step-by-step:
            buildout: plips/plip13260-step-by-step.cfg
            branch: 5.0
        - 13350-edit-member-schema-ttw:
            buildout: plips/plip13350-edit-member-schema-ttw.cfg
            branch: 5.0
        - 13770-portal-tools-removal:
            buildout: plips/plip13770-portal-tools-removal.cfg
            branch: 5.0
        - 20114-plone.api-integration:
            buildout: plips/plip20114-plone.api-integration.cfg
            branch: 5.0
        - 20256-social-tags:
            buildout: plips/plip20256-social-tags.cfg
            branch: 5.0
        - 14929-lxml-safehtml-transform:
            buildout: plips/plip14929-lxml-safehtml-transform.cfg
            branch: 5.0
        - ptc:
            buildout: plips/plip-ptc.cfg
            branch: 5.0

    jobs:
        - 'plip-{plip}'


- project:
    name: Theme preview
    plone-version:
        - '5.0'
        - '4.3'
    jobs:
        - 'plone-{plone-version}-themetest'


- project:
    name: Plone.org themepreview
    jobs:
        - 'ploneorg-themepreview'


- project:
    name: Theme test on browsers
    browser:
        - 'android':
            browser-name: 'android'
            platform: 'Linux'
            version: '4.1'
        - 'chrome':
            browser-name: 'chrome'
            platform: 'Windows 8'
            version: '26'
        - 'firefox':
            browser-name: 'firefox'
            platform: 'Windows 8'
            version: '26'
        - 'ie10':
            browser-name: 'Internet Explorer'
            platform: 'Windows 8'
            version: '10'
        - 'ie11':
            browser-name: 'Internet Explorer'
            platform: 'Windows 8'
            version: '11'
        - 'ie8':
            browser-name: 'Internet Explorer'
            platform: 'Windows 7'
            version: '8'
        - 'ie9':
            browser-name: 'Internet Explorer'
            platform: 'Windows 7'
            version: '9'
        - 'ipad':
            browser-name: 'ipad'
            platform: 'OS X 10.9'
            version: '7'
        - 'iphone':
            browser-name: 'iPhone'
            platform: 'OS X 10.9'
            version: '7'
        - 'safari':
            browser-name: 'safari'
            platform: 'OS X 10.9'
            version: '7'
    jobs:
        - 'plone-5.0-themetest-{browser}'


- job-template:
    # Plone 4.3 job definition.
    # TODO:
    # - email-ext quite a few things
    name: 'plone-4.3-python-{python-version}'
    project-type: freestyle
    display-name: 'Plone 4.3 - Python {python-version}'
    concurrent: true
    disabled: false
    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    properties:
        - custom-throttle:
            total: '0'
            enable: '' # false

        - disk-usage

    triggers:
        - github

    scm:
        - buildout-coredev:
            branch: '4.3'

    builders:
        - shell: |
            {pybinary} bootstrap.py -c jenkins.cfg
            bin/buildout -c jenkins.cfg
            bin/jenkins-alltests -1

    publishers:
        - custom-junit

        - custom-email-ext

        - robot:
            output-path: parts/jenkins-test
            report-html: robot_report.html
            log-html: robot_log.html
            output-xml: robot_output.xml
            pass-threshold: 100.0
            unstable-threshold: 80.0
            only-critical: true
            other-files:
                - robot_*.png

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator
        - custom-xvfb


- job:
    # Plone 5.0 core tests job definition.
    # TODO:
    # - email-ext quite a few things
    name: plone-5.0-python-2.7
    project-type: freestyle
    display-name: 'Plone 5.0 - Python 2.7'
    concurrent: true
    disabled: false

    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    properties:
        - custom-throttle:
            total: '7'
            enable: 'true'

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '5.0'

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c jenkins.cfg
            bin/buildout -c jenkins.cfg
            bin/alltests --xml

    triggers:
        - github

    publishers:

        - custom-junit-new

        - custom-email-ext

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator


- job:
    # Plone 5.0 robot tests job definition.
    # TODO:
    # - email-ext quite a few things
    name: plone-5.0-python-2.7-robot
    project-type: freestyle
    display-name: 'Plone 5.0 - Python 2.7 - Robot Framework Tests'
    concurrent: true
    disabled: false

    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    properties:
        - custom-throttle:
            total: '7'
            enable: 'true'

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '5.0'

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c jenkins.cfg
            bin/buildout -c jenkins.cfg
            ROBOTSUITE_PREFIX=ONLYROBOT
            bin/alltests -t ONLYROBOT --all --xml

    triggers:
        - github

    publishers:

        - custom-email-ext

        - robot:
            output-path: parts/test
            report-html: robot_report.html
            log-html: robot_log.html
            output-xml: robot_output.xml
            pass-threshold: 100.0
            unstable-threshold: 80.0
            only-critical: true
            other-files:
                - robot_*.png

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator
        - custom-xvfb

        - inject:
            properties-content: ROBOTSUITE_PREFIX=ONLYROBOT


- job:
    # Plone 5.0 Archetypes tests job definition.
    # TODO:
    # - copy artifact doNotFingerprintArtifacts
    # - email-ext quite a few things
    name: plone-5.0-python-2.7-at
    project-type: freestyle
    display-name: 'Plone 5.0 - Python 2.7 - Archetypes'
    concurrent: true
    disabled: false

    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    properties:
        - custom-throttle:
            total: '0'
            enable: '' # false

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '5.0'

    triggers:
        - github

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c jenkins.cfg
            bin/buildout -c jenkins.cfg
            bin/alltests-at --xml

        - copyartifact:
            project: plone-5.0-python-2.7
            filter: 'parts/test/testreports/*.xml'
            which-build: upstream-build
            optional: true


    publishers:
        - custom-junit-new

        - custom-archive:
            glob: 'parts/test/testreports/*.xml'

        - custom-email-ext

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator


- job-template:
    # PLIPs jobs definition
    name: 'plip-{plip}'
    project-type: freestyle
    display-name: 'PLIP - {plip}'
    concurrent: true
    disabled: false
    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    properties:
        - custom-throttle:
            total: '7'
            enable: 'true'

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '{branch}'

    triggers:
        - timed: "@midnight"

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c {buildout}
            bin/buildout -c {buildout}
            bin/alltests --xml --all
            bin/alltests-at --xml

    publishers:
        - custom-junit-new

        - robot:
            output-path: parts/test
            report-html: robot_report.html
            log-html: robot_log.html
            output-xml: robot_output.xml
            pass-threshold: 100.0
            unstable-threshold: 80.0
            only-critical: true
            other-files:
                - robot_*.png

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator
        - custom-xvfb


- job-template:
    # Plone theme preview.
    # TODO:
    # - email-ext quite a few things
    name: 'plone-{plone-version}-themetest'
    project-type: freestyle
    display-name: 'Plone {plone-version} - Themetest'
    concurrent: true
    disabled: false
    logrotate:
        daysToKeep: 20
        numToKeep: 30
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    notifications:
        - http:
            url: http://localhost
            format: JSON

    properties:
        - custom-throttle:
            total: '0'
            enable: '' # false

        - disk-usage

    scm:
        - git:
            url: git://github.com/plone/plone.themepreview.git
            branches:
                - 'master'
            wipe-workspace: false
            tag-builds: true

    triggers:
        - timed: '@midnight'

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c buildout.cfg
            bin/buildout -c buildout.cfg
            bin/sphinx-build source build

    publishers:
        - email-ext:
            recipients: tisto@plone.org, asko.soukka@iki.fi
            reply-to:
            content-type: default
            regression: true
            failure: false
            improvement: true
            still-failing: true
            fixed: true

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator
        - custom-xvfb


- job:
    # Plone.org theme preview.
    name: 'ploneorg-themepreview'
    project-type: freestyle
    display-name: 'Plone.org - theme preview'
    concurrent: true
    disabled: false
    logrotate:
        daysToKeep: 20
        numToKeep: 30
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    notifications:
        - http:
            url: http://localhost
            format: JSON

    properties:
        - custom-throttle:
            total: '0'
            enable: '' # false

        - disk-usage

    scm:
        - git:
            url: git://github.com/plone/ploneorg.core.git
            branches:
                - 'master'
            wipe-workspace: false
            tag-builds: true

    triggers:
        - timed: '@midnight'

    builders:
        - shell: |
            $PYTHON27 bootstrap.py -c buildout.cfg
            bin/buildout -c buildout.cfg
            bin/sphinx-build src/plone.themepreview/source build

    publishers:
        - html-publisher:
            name: report
            dir: build
            files: "index.html"
            keep-all: false
            allow-missing: false

    wrappers:
        - custom-workspace-cleanup
        - port-allocator:
            names:
                - ZSERVER_PORT
        - xvfb:
            name: default
            screen: 1200x900x24
            debug: false
            timeout: 0
            shutdown: false

        - inject:
            properties-content: |
                ROBOT_CONFIGURE_PACKAGES=plone.app.widgets,ploneorg.core
                ROBOT_APPLY_PROFILES=ploneorg.core:default
                ROBOT_INSTALL_PRODUCTS=Products.DateRecurringIndex


- job-template:
    # Plone 5.0 theme preview on browsers (using Sauce labs).
    name: 'plone-5.0-themetest-{browser}'
    project-type: freestyle
    display-name: 'Plone 5.0 - Theme test - {browser}'
    concurrent: true
    disabled: true
    logrotate:
        daysToKeep: 20
        numToKeep: 30
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    notifications:
        - http:
            url: http://localhost
            format: JSON

    properties:
        - throttle:
            max-total: '0'
            enabled: 'true'
            option: category
            categories:
                - sauce-labs-concurrent-builds-limit

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '5.0'

    triggers:
        - timed: '@midnight'

    builders:
        - shell: |
            # Set selenium grid variables
            export ROBOT_PORT=$ZSERVER_PORT
            export ROBOT_REMOTE_URL=$SAUCE_REMOTE_URL
            export ROBOT_BUILD_NUMBER=coredev-$BUILD_NUMBER
            export ROBOT_DESIRED_CAPABILITIES="platform:{platform},browserName:{browser-name},version:{version},tunnel-identifier:$NODE_NAME-$EXECUTOR_NUMBER"

            # This setups build-specific tunnel for Sauce Labs:
            rm -f CONNECTED
            if [ ! -f Sauce-Connect.jar ]
            then
                wget http://saucelabs.com/downloads/Sauce-Connect-latest.zip
                unzip Sauce-Connect-latest.zip
            fi
            java -jar Sauce-Connect.jar $SAUCE_USERNAME $SAUCE_ACCESS_KEY -i $NODE_NAME-$EXECUTOR_NUMBER -f CONNECTED 1>/dev/null &
            JAVA_PID=$!
            bash -c "while [ ! -f CONNECTED ]; do sleep 2; done"

            # This just runs robot tests as usual
            export ROBOT_APPLY_PROFILES=plone.app.contenttypes:default
            export ROBOT_INSTALL_PRODUCTS=Products.DateRecurringIndex

            $PYTHON27 bootstrap.py -c buildout.cfg
            bin/buildout -c buildout.cfg
            bin/themepreview-build src/plone.themepreview/source build

            # Finally, this kills the tunnel
            kill -0 $JAVA_PID && kill $JAVA_PID || true

    publishers:
        - html-publisher:
            name: report
            dir: build
            files: "index.html"
            keep-all: false
            allow-missing: false

    wrappers:
        - custom-workspace-cleanup
        - timeout:
            timeout: 240
            type: absolute
        - port-allocator:
            names:
                - ZSERVER_PORT

- job:
    name: 'workflow-5.0'
    project-type: workflow
    definitions:
        - script:
            filename: 'flow.groovy'
        - scm:
            url: https://github.com/plone/jenkins.plone.org.git
            branches:
                - '*/master'


- job:
    name: 'pull-request'
    project-type: freestyle
    display-name: 'Pull Request'
    concurrent: true
    disabled: false
    logrotate:
        daysToKeep: 60
        numToKeep: 100
        artifactDaysToKeep: 3
        artifactNumToKeep: 10

    parameters:
#        - text:
#            name: PULL_REQUEST_URL
#            description: 'URL of the github pull request, e.g. "https://github.com/plone/Products.CMFPlone/pull/251".'
#            default: https://github.com/plone/Products.CMFPlone/pull/251
        - text:
            name: PULL_REQUEST_PACKAGE_NAME
            description: 'Name of the Package, e.g. "Products.CMFPlone".'
            default: plone.app.discussion
        - text:
            name: PULL_REQUEST_BRANCH
            description: 'Name of the git branch, e.g. "z3cform-language-controlpanel".'
            default: email-anon-bug
        - text:
            name: NOTIFICATION_EMAIL_ADDRESS
            description: 'Jenkins will send an email notification to this email address when the job is done.'
            default: tisto@plone.org

    properties:
        - custom-throttle:
            total: '7'
            enable: 'true'

        - disk-usage

    scm:
        - buildout-coredev:
            branch: '5.0'

    builders:
        - shell: |
            $PYTHON27 bootstrap.py --setuptools-version=8.3 -c jenkins.cfg
            sed -ie "s/^$PULL_REQUEST_PACKAGE_NAME.*/$PULL_REQUEST_PACKAGE_NAME = git git:\/\/github.com\/plone\/$PULL_REQUEST_PACKAGE_NAME.git branch=$PULL_REQUEST_BRANCH/g" sources.cfg
            bin/buildout -c jenkins.cfg install add-package-to-auto-checkout
            bin/add-package-to-auto-checkout $PULL_REQUEST_PACKAGE_NAME
            bin/buildout -c jenkins.cfg
            bin/alltests --xml --all
            bin/alltests-at --xml

    publishers:
        - custom-junit-new

        - robot:
            output-path: parts/test
            report-html: robot_report.html
            log-html: robot_log.html
            output-xml: robot_output.xml
            pass-threshold: 100.0
            unstable-threshold: 80.0
            only-critical: true
            other-files:
                - robot_*.png

        - email-ext:
            recipients: ${NOTIFICATION_EMAIL_ADDRESS}
            reply-to:
            content-type: default
            regression: true
            failure: false
            improvement: true
            still-failing: true
            fixed: true

    wrappers:
        - custom-workspace-cleanup
        - custom-timeout
        - custom-port-allocator
        - custom-xvfb

###
# MACROS
###

- property:
    name: custom-throttle
    properties:
        - throttle:
            max-total: '{total}'
            enabled: '{enable}'
            option: project

- scm:
    name: buildout-coredev
    scm:
        - git:
            url: git://github.com/plone/buildout.coredev.git
            branches:
                - '{branch}'
            wipe-workspace: false
            tag-builds: true

- publisher:
    name: custom-junit
    publishers:
        - junit:
            results: parts/jenkins-test/testreports/*.xml
            keep-long-stdio: false

- publisher:
    name: custom-junit-new
    publishers:
        - junit:
            results: parts/test/testreports/*.xml
            keep-long-stdio: false

- publisher:
    name: custom-email-ext
    publishers:
        - email-ext:
            recipients: plone-testbot@lists.plone.org
            reply-to:
            content-type: default
            regression: true
            failure: false
            improvement: true
            still-failing: true
            fixed: true

- publisher:
    name: custom-archive
    publishers:
        - archive:
            artifacts: '{glob}'
            allow-empty: 'true'

- wrapper:
    name: custom-workspace-cleanup
    wrappers:
        - workspace-cleanup:
            dirmatch: true

- wrapper:
    name: custom-timeout
    wrappers:
        - timeout:
            timeout: 180
            type: absolute

- wrapper:
    name: custom-port-allocator
    wrappers:
        - port-allocator:
            names:
                - ZSERVER_PORT
                - FTPSERVER_PORT

- wrapper:
    name: custom-xvfb
    wrappers:
        - xvfb:
            name: default
            screen: 1024x768x24
            debug: false
            timeout: 0
            shutdown: false
