---
# Jenkins server for Plone CI testing

# TODO(gforcada) remove it as soon as jenkins master is on Ubuntu 16.04
- hosts: jenkins.plone.org
  remote_user: root
  tasks:
    - name: Install repository for Java 8 in Ubuntu
      become: yes
      apt_repository: repo='ppa:openjdk-r/ppa'

    - name: Update
      become: yes
      apt:
        update_cache=yes

    - name: Install Java 8
      become: yes
      apt:
        name=openjdk-8-jdk
        state=installed

    - name: Fix java version selected
      become: yes
      alternatives:
        name: java
        path: /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

- hosts: jenkins.plone.org
  remote_user: root
  roles:
    - plone.jenkins_server
  vars:
    admin_email: gil.gnome@gmail.com
    simple_theme_css_url: https://rawgit.com/plone/jenkins.plone.org/master/files/jenkins.plone.org.css
    simple_theme_js_url: https://cdnjs.cloudflare.com/ajax/libs/doony/2.1/js/doony.min.js
    jenkins_admins:
      - tisto
      - gforcada
      - svx
      - bloodbare
    github_orgs:
      - plone
      - collective
    nodes_info:
      - name: "Node1"
        host: "88.99.26.113"
        port: "8085"
      - name: "Node2"
        host: "88.99.26.113"
        port: "8086"
      - name: "Node3"
        host: "88.99.26.113"
        port: "8087"
  vars_files:
    - secrets.yml

  tasks:

    # Set Hostname
    - hostname: name=jenkins.plone.org

    # Install mr.roboto
    - name: Install nginx-extras
      apt: name=nginx-extras state=present
    - name: Install supervisor
      pip: name=supervisor
    - name: Checkout mr.roboto
      git: repo=https://github.com/plone/mr.roboto.git dest=/srv/mr.roboto
    - name: Create a virtualenv for mr.roboto
      pip:
        requirements=/srv/mr.roboto/requirements.txt
        virtualenv=/srv/mr.roboto
        virtualenv_command=/srv/python2.7.11/bin/virtualenv
    - name: Run mr.roboto bootstrap
      shell: bin/python2.7 bootstrap.py
        chdir=/srv/mr.roboto/
        creates=/srv/mr.roboto/bin/buildout
    - name: Run mr.roboto buildout
      shell: bin/buildout
        chdir=/srv/mr.roboto/
      notify: Restart mr.roboto
    - lineinfile: dest=/usr/lib/python2.7/sitecustomize.py line="import sys; sys.setdefaultencoding('utf-8');"

    # Install munin
    - name: Install munin
      apt: name=munin state=present
    - lineinfile: dest=/etc/munin/munin.conf regexp=^#htmldir line="htmldir /var/cache/munin/www"
    - lineinfile: dest=/etc/munin/munin.conf regexp=^#tmpldir line="tmpldir /etc/munin/templates"
    - lineinfile: dest=/etc/munin/munin.conf regexp=^[localhost.localdomain] line="[jenkins.plone.org]"
    # XXX: not sure if we want to protect munin with pw yet.
    #- htpasswd: path=/etc/nginx/passwdfile name=guest password=guest owner=root group=www-data mode=0640

  handlers:

    - name: Start mr.roboto
      supervisorctl:
        name="roboto:"
        state=started
        config=/srv/mr.roboto/supervisord.conf
    - name: Restart mr.roboto
      supervisorctl:
        name="roboto:"
        state=restarted
        config=/srv/mr.roboto/supervisord.conf
