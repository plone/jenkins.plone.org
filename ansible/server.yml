---
# Jenkins server for Plone CI testing

# TODO(gforcada) remove it as soon as jenkins master is on Ubuntu 16.04
- hosts: jenkins.plone.org
  remote_user: root
  tasks:
    - name: Install repository for Java 8 in Ubuntu
      become: yes
      apt_repository: repo='ppa:openjdk-r/ppa'

    - name: Update
      become: yes
      apt:
        update_cache=yes

    - name: Install Java 8
      become: yes
      apt:
        name=openjdk-8-jdk
        state=installed

    - name: Fix java version selected
      become: yes
      alternatives:
        name: java
        path: /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

- hosts: jenkins.plone.org
  remote_user: root
  roles:
    - plone.jenkins_server
  vars:
    admin_email: gil.gnome@gmail.com
    simple_theme_css_url: https://rawgit.com/plone/jenkins.plone.org/master/files/jenkins.plone.org.css
    simple_theme_js_url: https://cdnjs.cloudflare.com/ajax/libs/doony/2.1/js/doony.min.js
    jenkins_admins:
      - tisto
      - gforcada
      - svx
    github_orgs:
      - plone
      - collective
    nodes_info:
      - name: "Node1"
        host: "88.99.26.113"
        port: "8085"
      - name: "Node2"
        host: "88.99.26.113"
        port: "8086"
      - name: "Node3"
        host: "88.99.26.113"
        port: "8087"
      - name: "Node4"
        host: "tau.vm.zoplo.com"
        port: "22"
  vars_files:
    - secrets.yml

  tasks:

    # Set Hostname
    - hostname: name=jenkins.plone.org

    # Install mr.roboto
    - name: Install nginx-extras
      apt:
        name=nginx-extras
        state=present

    - name: Checkout mr.roboto
      git:
        repo=https://github.com/plone/mr.roboto.git
        dest=/srv/mr.roboto

    - name: Create a virtualenv for mr.roboto
      pip:
        requirements=/srv/mr.roboto/requirements.txt
        virtualenv=/srv/mr.roboto
        virtualenv_command="/srv/python3.6/bin/python3.6 -m venv"

    - name: Run mr.roboto buildout
      shell: bin/buildout
        chdir=/srv/mr.roboto/
      notify: Restart mr.roboto

    # Install munin
    - name: Install munin
      apt: name=munin state=present

    - name: Set htmldir variable
      lineinfile:
        dest=/etc/munin/munin.conf
        regexp=^#htmldir
        line="htmldir /var/cache/munin/www"

    - name: Set tmpldir variable
      lineinfile:
        dest=/etc/munin/munin.conf
        regexp=^#tmpldir
        line="tmpldir/etc/munin/templates"

    - name: Set domain in configuration
      lineinfile:
        dest=/etc/munin/munin.conf
        regexp=^[localhost.localdomain]
        line="[jenkins.plone.org]"

    - cron:
        name: Start mr.roboto at reboot
        special_time: reboot
        job: "supervisord -c /srv/mr.roboto/supervisord.conf"
        user: root

  handlers:

    - name: Start mr.roboto
      supervisorctl:
        name="roboto:"
        state=started
        config=/srv/mr.roboto/supervisord.conf
        supervisorctl_path=/srv/mr.roboto/bin/supervisorctl

    - name: Restart mr.roboto
      supervisorctl:
        name="roboto:"
        state=restarted
        config=/srv/mr.roboto/supervisord.conf
        supervisorctl_path=/srv/mr.roboto/bin/supervisorctl
